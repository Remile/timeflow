{% extends "base.html" %}

{% block title %}ç»Ÿè®¡ - ç”Ÿæ´»æ—¥å¿—{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ğŸ“Š ç»Ÿè®¡åˆ†æ</h2>
    <p class="subtitle">äº†è§£ä½ çš„æ—¶é—´éƒ½èŠ±åœ¨å“ªé‡Œ</p>
</div>

<div class="period-selector">
    <a href="/stats?period=today" class="btn {% if period == 'today' %}btn-primary{% else %}btn-secondary{% endif %}">ä»Šæ—¥</a>
    <a href="/stats?period=week" class="btn {% if period == 'week' %}btn-primary{% else %}btn-secondary{% endif %}">æœ¬å‘¨</a>
    <a href="/stats?period=month" class="btn {% if period == 'month' %}btn-primary{% else %}btn-secondary{% endif %}">æœ¬æœˆ</a>
    <a href="/stats?period=all" class="btn {% if period == 'all' %}btn-primary{% else %}btn-secondary{% endif %}">å…¨éƒ¨</a>
</div>

<div class="stats-overview">
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_logs }}</div>
        <div class="stat-label">æ€»æ—¥å¿—æ•°</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-value">{{ stats.total_duration_minutes }}</div>
        <div class="stat-label">æ€»è€—æ—¶ (åˆ†é’Ÿ)</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-value">{{ "%.1f"|format(stats.total_duration_minutes / 60) }}</div>
        <div class="stat-label">æ€»è€—æ—¶ (å°æ—¶)</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-value">{{ stats.category_counts|length }}</div>
        <div class="stat-label">æ´»åŠ¨ç±»åˆ«</div>
    </div>
</div>

<div class="charts-container">
    <div class="chart-card">
        <h3>åˆ†ç±»åˆ†å¸ƒ</h3>
        <canvas id="categoryChart"></canvas>
    </div>
    
    <div class="chart-card">
        <h3>åˆ†ç±»è€—æ—¶åˆ†å¸ƒ</h3>
        <canvas id="durationChart"></canvas>
    </div>
</div>

<div class="charts-container">
    <div class="chart-card full-width">
        <h3>æ¯æ—¥æ—¥å¿—æ•°é‡</h3>
        <canvas id="dailyChart"></canvas>
    </div>
</div>

{% if stats.top_tags %}
<div class="tags-cloud">
    <h3>ğŸ·ï¸ çƒ­é—¨æ ‡ç­¾</h3>
    <div class="tags-container">
        {% for tag, count in stats.top_tags.items() %}
        <span class="tag tag-size-{{ (count / stats.top_tags.values()|list|max * 3)|int + 1 }}">
            {{ tag }} <small>({{ count }})</small>
        </span>
        {% endfor %}
    </div>
</div>
{% endif %}

<div class="category-details">
    <h3>ğŸ“ åˆ†ç±»è¯¦æƒ…</h3>
    <table class="stats-table">
        <thead>
            <tr>
                <th>åˆ†ç±»</th>
                <th>æ•°é‡</th>
                <th>è€—æ—¶ (åˆ†é’Ÿ)</th>
                <th>å æ¯”</th>
            </tr>
        </thead>
        <tbody>
            {% for category, count in stats.category_counts.items()|sort(attribute='1', reverse=true) %}
            <tr>
                <td><span class="category-badge category-{{ category }}">{{ category }}</span></td>
                <td>{{ count }}</td>
                <td>{{ stats.duration_by_category.get(category, 0) }}</td>
                <td>{{ "%.1f"|format(count / stats.total_logs * 100) }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
// Category distribution pie chart
const categoryData = {{ stats.category_counts|tojson }};
const categoryLabels = Object.keys(categoryData);
const categoryCounts = Object.values(categoryData);

const categoryColors = {
    'å·¥ä½œ': '#3b82f6',
    'å­¦ä¹ ': '#10b981',
    'å¨±ä¹': '#f59e0b',
    'è¿åŠ¨': '#ef4444',
    'ç¤¾äº¤': '#8b5cf6',
    'ç”Ÿæ´»': '#06b6d4',
    'å…¶ä»–': '#6b7280'
};

const categoryBgColors = categoryLabels.map(label => categoryColors[label] || '#6b7280');

new Chart(document.getElementById('categoryChart'), {
    type: 'pie',
    data: {
        labels: categoryLabels,
        datasets: [{
            data: categoryCounts,
            backgroundColor: categoryBgColors,
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom',
            }
        }
    }
});

// Duration by category bar chart
const durationData = {{ stats.duration_by_category|tojson }};
const durationLabels = Object.keys(durationData);
const durationValues = Object.values(durationData);
const durationColors = durationLabels.map(label => categoryColors[label] || '#6b7280');

new Chart(document.getElementById('durationChart'), {
    type: 'bar',
    data: {
        labels: durationLabels,
        datasets: [{
            label: 'è€—æ—¶ (åˆ†é’Ÿ)',
            data: durationValues,
            backgroundColor: durationColors,
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false,
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Daily log count line chart
const dailyData = {{ stats.daily_counts|tojson }};
const dailyLabels = Object.keys(dailyData).sort();
const dailyCounts = dailyLabels.map(date => dailyData[date]);

new Chart(document.getElementById('dailyChart'), {
    type: 'line',
    data: {
        labels: dailyLabels,
        datasets: [{
            label: 'æ—¥å¿—æ•°é‡',
            data: dailyCounts,
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                display: false,
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1
                }
            }
        }
    }
});
</script>
{% endblock %}

