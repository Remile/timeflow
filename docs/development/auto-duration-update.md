# 自动时长更新功能

## 功能概述

当你录入一条新的日志时，系统会自动计算并更新**当天上一条日志**的时长。这个功能基于这样的假设：当你开始记录新活动时，意味着上一个活动已经结束或暂时结束了。

## 工作原理

### 自动更新逻辑

1. **触发时机**：当你使用 `logger add` 命令添加新日志时
2. **查找目标**：系统会在当天（00:00:00 至 23:59:59）范围内，查找最近的一条日志
3. **计算时长**：计算新日志时间戳与上一条日志时间戳的时间差（以分钟为单位）
4. **自动更新**：将计算出的时长更新到上一条日志的 `duration_estimate` 字段

### 示例场景

假设你今天的活动如下：

```
08:20 - 开始写代码（创建日志1，初始时长=0）
08:50 - 开始开会（创建日志2）→ 日志1的时长自动更新为 30 分钟
09:30 - 开始午休（创建日志3）→ 日志2的时长自动更新为 40 分钟
```

最终的日志记录：
- 日志1：写代码，时长 30 分钟
- 日志2：开会，时长 40 分钟
- 日志3：午休，时长 0 分钟（等待下一条日志更新）

## 使用体验

### 添加日志时的提示

当你添加新日志时，如果成功更新了上一条日志的时长，会看到如下提示：

```
💾 保存到数据库...
⏱  已自动更新上一条日志 (ID: 5) 的时长：45 分钟
✅ 日志已保存！ (ID: 6)
```

### 查看日志时长

使用 `logger list` 命令查看日志时，会显示每条日志的时长：

```bash
# 查看今天的日志
logger list --today

# 查看最近的日志
logger list -l 10
```

## 技术细节

### 数据库操作

新增了以下方法到 `LogOperations` 类：

1. **`auto_update_previous_log_duration(new_log_time)`**
   - 自动查找并更新上一条日志的时长
   - 参数：`new_log_time` - 新日志的时间戳
   - 返回：`(previous_log, calculated_duration)` 或 `None`

2. **`update_log_duration(log_id, duration_minutes)`**
   - 手动更新指定日志的时长
   - 参数：日志ID和时长（分钟）

3. **`get_last_log_of_day(target_date)`**
   - 获取指定日期的最后一条日志

### 时间范围

- **同一天**：只更新当天（00:00:00 至 23:59:59）范围内的日志
- **跨天**：不会更新前一天的日志，因为每天的活动是相对独立的

## 注意事项

1. **最后一条日志**：每天的最后一条日志的时长会保持为AI估计的时长，直到添加下一条日志时才会被更新

2. **手动编辑**：如果你想手动修改某条日志的时长，可以直接在数据库中更新（未来可能添加命令行支持）

3. **时间准确性**：时长的准确性取决于你记录日志的及时性，建议在活动切换时尽快记录

## 优势

- ✅ **自动化**：无需手动计算和输入时长
- ✅ **准确**：基于实际时间戳计算，避免估计误差
- ✅ **便捷**：专注于记录当前活动，系统自动处理历史数据
- ✅ **智能**：只更新当天的日志，保持数据的逻辑一致性

## 未来改进

可能的功能增强：

- [ ] 添加命令行选项来禁用自动更新（`--no-auto-duration`）
- [ ] 支持手动编辑日志时长的CLI命令
- [ ] 在Web界面中显示活动时间线
- [ ] 支持跨天活动的时长计算选项

